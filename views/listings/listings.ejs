<% layout('layouts/boilerplate') %>

<div class="container py-5">
    <!-- Page Header -->
    <div class="section-header mb-4">
        <h2>All Listings</h2>
        <p class="text-airbnb-gray"><%= listings.length %> stays available</p>
    </div>

    <!-- Listings Grid -->
    <% if (listings.length > 0) { %>
        <div class="airbnb-grid">
            <% listings.forEach((listing) => { %>
                <a href="/listings/<%= listing._id %>" class="airbnb-card">
                    <div class="airbnb-card-image">
                        <% if (listing.image && listing.image.url) { %>
                            <img src="<%= listing.image.url %>" alt="<%= listing.title %>">
                        <% } else { %>
                            <img src="https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400" alt="<%= listing.title %>">
                        <% } %>
                        
                        <!-- Guest Favorite Badge (if highly rated) -->
                        <% if (listing.reviews && listing.reviews.length > 3) { %>
                            <% 
                                const totalRating = listing.reviews.reduce((sum, review) => sum + review.rating, 0);
                                const averageRating = (totalRating / listing.reviews.length).toFixed(1);
                            %>
                            <% if (averageRating >= 4.8) { %>
                                <span class="guest-favorite">Guest favourite</span>
                            <% } %>
                        <% } %>
                        
                        <!-- Wishlist Button -->
                        <button class="wishlist-btn" onclick="event.preventDefault(); toggleWishlist(this);">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                    
                    <div class="airbnb-card-content">
                        <!-- Location and Rating -->
                        <div class="card-location">
                            <h3><%= listing.location %>, <%= listing.country %></h3>
                            <% if (listing.reviews && listing.reviews.length > 0) { %>
                                <% 
                                    const totalRating = listing.reviews.reduce((sum, review) => sum + review.rating, 0);
                                    const averageRating = (totalRating / listing.reviews.length).toFixed(2);
                                %>
                                <div class="card-rating">
                                    <i class="fas fa-star"></i>
                                    <span><%= averageRating %></span>
                                </div>
                            <% } else { %>
                                <div class="card-rating">
                                    <span class="text-muted" style="font-size: 13px;">New</span>
                                </div>
                            <% } %>
                        </div>
                        
                        <!-- Title -->
                        <div class="card-title" title="<%= listing.title %>">
                            <%= listing.title %>
                        </div>
                        
                        <!-- Description (if short enough) -->
                        <% if (listing.description && listing.description.length <= 50) { %>
                            <div class="card-title text-airbnb-gray" style="font-size: 14px;">
                                <%= listing.description %>
                            </div>
                        <% } %>
                        
                        <!-- Price -->
                        <div class="card-price">
                            <strong>â‚¹<%= listing.price.toLocaleString('en-IN') %></strong> per night
                        </div>
                    </div>
                </a>
            <% }); %>
        </div>
    <% } else { %>
        <!-- Empty State -->
        <div class="text-center py-5">
            <i class="fas fa-home display-1 text-muted mb-4 opacity-50"></i>
            <h3 class="text-muted mb-3">No listings found</h3>
            <p class="text-muted mb-4">Be the first to add a property!</p>
            <% if (typeof currentUser !== 'undefined' && currentUser) { %>
                <a href="/listings/new" class="btn-airbnb btn-lg">
                    <i class="fas fa-plus me-2"></i>Add Your First Listing
                </a>
            <% } else { %>
                <a href="/auth/signup" class="btn-airbnb btn-lg">
                    <i class="fas fa-user-plus me-2"></i>Sign up to add listing
                </a>
            <% } %>
        </div>
    <% } %>
</div>

<script>
// Wishlist toggle functionality
function toggleWishlist(button) {
    const icon = button.querySelector('i');
    if (icon.classList.contains('far')) {
        icon.classList.remove('far');
        icon.classList.add('fas');
        icon.style.color = '#FF385C';
    } else {
        icon.classList.remove('fas');
        icon.classList.add('far');
        icon.style.color = '';
    }
}
</script>

<style>
/* Additional styles for listings page */
.airbnb-card {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Stagger animation for cards */
.airbnb-card:nth-child(1) { animation-delay: 0.05s; }
.airbnb-card:nth-child(2) { animation-delay: 0.1s; }
.airbnb-card:nth-child(3) { animation-delay: 0.15s; }
.airbnb-card:nth-child(4) { animation-delay: 0.2s; }
.airbnb-card:nth-child(5) { animation-delay: 0.25s; }
.airbnb-card:nth-child(6) { animation-delay: 0.3s; }
</style>